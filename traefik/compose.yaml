name: traefik

networks:
  traefik_network:
    name: traefik_network

secrets:
  infomaniak_access_token:
    file: ./infomaniak_access_token.txt

services:
  traefik:
    container_name: traefik
    image: traefik:${TRAEFIK_VERSION}
    command:
      - --configFile=/etc/traefik/traefik_static.yaml
    restart: unless-stopped
    environment:
      - INFOMANIAK_ACCESS_TOKEN_FILE=/run/secrets/infomaniak_access_token
    networks:
      - traefik_network
    ports:
      - 80:80
      - 443:443
    secrets:
      - infomaniak_access_token
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/etc/letsencrypt
      - ./traefik_static.yaml:/etc/traefik/traefik_static.yaml:ro
      - ./traefik_dynamic.yaml:/etc/traefik/traefik_dynamic.yaml:ro
    labels:
      # Traefik
      - traefik.enable=true
      ## HTTPS
      - traefik.http.routers.traefik.entryPoints=websecure
      - traefik.http.routers.traefik.rule=Host(`${TRAEFIK_FQDN}`)
      - traefik.http.routers.traefik.service=api@internal
      ## Homepage
      - homepage.group=Infrastructure
      - homepage.name=Traefik
      - homepage.icon=traefik.svg
      - homepage.href=https://${TRAEFIK_FQDN}
      - homepage.description=A modern reverse proxy.
